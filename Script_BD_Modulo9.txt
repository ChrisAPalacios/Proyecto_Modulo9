DROP DATABASE IF EXISTS prototype3;
CREATE DATABASE prototype3;
USE prototype3;

-- ===== CATÁLOGO =====
CREATE TABLE ALCALDIA (
    ID_ALCALDIA INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE_ALCALDIA VARCHAR(40) UNIQUE NOT NULL
);

CREATE TABLE COLONIA (
    ID_COLONIA INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE_COLONIA VARCHAR(50) UNIQUE NOT NULL,
    ID_ALCALDIA INT,
    CONSTRAINT FK_ALCALDIA_COLONIA FOREIGN KEY (ID_ALCALDIA)
        REFERENCES ALCALDIA(ID_ALCALDIA) ON DELETE CASCADE
);

CREATE TABLE ZONA (
    ID_ZONA INT AUTO_INCREMENT PRIMARY KEY,
    NOMBREZONA VARCHAR(150) NOT NULL,
    PRECIO DECIMAL(7,2) NOT NULL,
    CAPACIDAD INT CHECK (CAPACIDAD >= 0)
);

CREATE TABLE TIPO_EVENTO (
    ID_TIPOEVENTO INT AUTO_INCREMENT PRIMARY KEY,
    TIPO VARCHAR(150) UNIQUE NOT NULL
);

-- ===== USUARIOS =====
CREATE TABLE USUARIO (
    ID_USUARIO INT AUTO_INCREMENT PRIMARY KEY,
    PILA VARCHAR(150) NOT NULL,
    AP_PATERNO VARCHAR(150) NOT NULL,
    AP_MATERNO VARCHAR(150),
    CORREO VARCHAR(150) UNIQUE NOT NULL,
    TELEFONO BIGINT(10) NOT NULL CHECK (LENGTH(TELEFONO) = 10),
    TIPOUSUARIO ENUM('CLIENTE', 'ADMINI') NOT NULL,
    PASSWORD VARCHAR(100) NOT NULL
);

CREATE TABLE CLIENTE (
    ID_USUARIO INT PRIMARY KEY,
    FECHA_REGISTRO DATE NOT NULL,
    METODO_PAGO ENUM('PAYPAL', 'CREDITO', 'DEBITO') NOT NULL,
    CONSTRAINT FK_USUARIOCLIENTE FOREIGN KEY (ID_USUARIO)
        REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

CREATE TABLE ADMINI (
    ID_USUARIO INT PRIMARY KEY,
    RFC VARCHAR(13) NOT NULL,
    FECHA_ALTA DATE NOT NULL,
    CONSTRAINT FK_USUARIOADMINI FOREIGN KEY (ID_USUARIO)
        REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

CREATE TABLE DIRECCION (
    ID_DIRECCION INT AUTO_INCREMENT PRIMARY KEY,
    CALLE VARCHAR(150) NOT NULL,
    NUMINT VARCHAR(10),
    NUMEXT VARCHAR(10) NOT NULL,
    ID_USUARIO INT NOT NULL,
    ID_ALCALDIA INT NOT NULL,
    CONSTRAINT FK_ALCALDIA FOREIGN KEY (ID_ALCALDIA)
        REFERENCES ALCALDIA(ID_ALCALDIA) ON DELETE CASCADE,
    CONSTRAINT FK_USUARIOD FOREIGN KEY (ID_USUARIO)
        REFERENCES USUARIO(ID_USUARIO) ON DELETE CASCADE
);

-- ===== EVENTOS Y BOLETOS =====
CREATE TABLE EVENTO (
    ID_EVENTO INT AUTO_INCREMENT PRIMARY KEY,
    NOMBRE_EVENTO VARCHAR(150) NOT NULL,
    FECHA DATE,
    DURACION INT,
    ID_TIPOEVENTO INT NOT NULL,
    CONSTRAINT FK_TIPO_EVENTO_BOLETO FOREIGN KEY (ID_TIPOEVENTO)
        REFERENCES TIPO_EVENTO(ID_TIPOEVENTO) ON DELETE CASCADE
);

CREATE TABLE ASIENTO (
    ID_ASIENTO INT AUTO_INCREMENT PRIMARY KEY,
    NUMERO_ASIENTO VARCHAR(150) NOT NULL UNIQUE,
    ID_ZONA INT NOT NULL,
    CONSTRAINT FK_ASIENTO_ZONA FOREIGN KEY (ID_ZONA)
        REFERENCES ZONA(ID_ZONA) ON DELETE CASCADE
);

CREATE TABLE ASIENTO_EVENTO (
    ID_EVENTO INT NOT NULL,
    ID_ASIENTO INT NOT NULL,
    ESTADO VARCHAR(20) DEFAULT 'DISPONIBLE',
    PRIMARY KEY (ID_EVENTO, ID_ASIENTO),
    CONSTRAINT FK_ASIENTO_EVENTO_EVENTO FOREIGN KEY (ID_EVENTO)
        REFERENCES EVENTO(ID_EVENTO) ON DELETE CASCADE,
    CONSTRAINT FK_ASIENTO_EVENTO_ASIENTO FOREIGN KEY (ID_ASIENTO)
        REFERENCES ASIENTO(ID_ASIENTO) ON DELETE CASCADE
);

-- ===== COMPRA primero para evitar error de clave foránea =====
CREATE TABLE COMPRA (
    ID_COMPRA INT AUTO_INCREMENT PRIMARY KEY,
    FECHACOMPRA DATE NOT NULL,
    MONTOTOTAL DECIMAL(20,2),
    ID_USUARIO INT NOT NULL,
    ID_DEVOLUCION INT, -- Esto se agregará correctamente después con ALTER TABLE
    CONSTRAINT FK_COMPRA_USUARIO FOREIGN KEY (ID_USUARIO)
        REFERENCES CLIENTE(ID_USUARIO) ON DELETE CASCADE
);

-- ===== DEVOLUCION después, con referencia a COMPRA
CREATE TABLE DEVOLUCION (
    ID_DEVOLUCION INT AUTO_INCREMENT PRIMARY KEY,
    FECHA_DEVOLUCION DATE,
    MOTIVO TEXT,
    ID_COMPRA INT UNIQUE,
    CONSTRAINT FK_DEVOLUCION_COMPRA FOREIGN KEY (ID_COMPRA)
        REFERENCES COMPRA(ID_COMPRA) ON DELETE CASCADE
);

-- ===== Relación circular se resuelve con ALTER TABLE
ALTER TABLE COMPRA
    ADD CONSTRAINT FK_COMPRA_DEVOLUCION FOREIGN KEY (ID_DEVOLUCION)
    REFERENCES DEVOLUCION(ID_DEVOLUCION) ON DELETE CASCADE;

-- ===== BOLETOS
CREATE TABLE BOLETO (
    ID_BOLETO INT AUTO_INCREMENT PRIMARY KEY,
    ESTADO ENUM('Disponible', 'Vendido', 'Reservado') NOT NULL,
    ID_USUARIO INT NOT NULL,
    ID_ASIENTO INT NOT NULL UNIQUE,
    ID_EVENTO INT NOT NULL,
    ID_COMPRA INT NOT NULL,
    ID_DEVOLUCION INT,
    CONSTRAINT FK_USUARIO_CLIENTE_BOLETO FOREIGN KEY (ID_USUARIO)
        REFERENCES CLIENTE(ID_USUARIO) ON DELETE CASCADE,
    CONSTRAINT FK_BOLETO_ASIENTO FOREIGN KEY (ID_ASIENTO)
        REFERENCES ASIENTO(ID_ASIENTO) ON DELETE CASCADE,
    CONSTRAINT FK_BOLETO_EVENTO FOREIGN KEY (ID_EVENTO)
        REFERENCES EVENTO(ID_EVENTO) ON DELETE CASCADE,
    CONSTRAINT FK_BOLETO_COMPRA FOREIGN KEY (ID_COMPRA)
        REFERENCES COMPRA(ID_COMPRA) ON DELETE CASCADE,
    CONSTRAINT FK_BOLETO_DEVOLUCION FOREIGN KEY (ID_DEVOLUCION)
        REFERENCES DEVOLUCION(ID_DEVOLUCION) ON DELETE SET NULL
);

INSERT INTO USUARIO (
    PILA, AP_PATERNO, AP_MATERNO, CORREO, TELEFONO, TIPOUSUARIO, PASSWORD
) VALUES (
    'Admin', 'Sistema', 'Principal', 'admin@eventia.com', 5551234567, 'ADMINI', 'admin123'
);

INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (1, 'Rock');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (2, 'Jazz');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (3, 'Pop');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (4, 'Folklor');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (5, 'Clásica');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (6, 'Reguetón');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (7, 'Blues');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (8, 'Electrónica');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (9, 'Hip-Hop');
INSERT INTO TIPO_EVENTO (ID_TIPOEVENTO, TIPO) VALUES (10, 'Banda');

INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (1, 'Rock Fest 2025', '2025-06-10', 180, 1);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (2, 'Jazz Night con Herbie Hancock', '2025-07-22', 150, 2);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (3, 'Taylor Swift Eras Tour', '2025-08-15', 210, 3);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (4, 'Kevin Kaarl ULTRA SODADE', '2025-09-05', 120, 4);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (5, 'Orquesta Sinfónica de Viena', '2025-10-10', 200, 5);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (6, 'Bad Bunny DeBí TiRAR MÁS FOTOs', '2025-11-20', 180, 6);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (7, 'BB King Tributo', '2025-12-08', 160, 7);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (8, 'Tomorrowland Festival', '2025-12-25', 300, 8);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (9, 'Kendrick Lamar Live', '2025-06-30', 140, 9);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (10, 'Banda MS en Vivo', '2025-07-18', 180, 10);
INSERT INTO EVENTO (ID_EVENTO, NOMBRE_EVENTO, FECHA, DURACION, ID_TIPOEVENTO) VALUES (11, 'Humbe', '2025-04-26', 120, 8);

-- ===== INSERTS PARA PRUEBAS DE POSTMAN =====

INSERT INTO ZONA (ID_ZONA, NOMBREZONA, PRECIO, CAPACIDAD) VALUES (1, 'VIP', 2500.00, 100);
INSERT INTO ZONA (ID_ZONA, NOMBREZONA, PRECIO, CAPACIDAD) VALUES (2, 'General', 800.00, 500);
INSERT INTO ZONA (ID_ZONA, NOMBREZONA, PRECIO, CAPACIDAD) VALUES (3, 'Preferente', 1500.00, 300);
INSERT INTO ZONA (ID_ZONA, NOMBREZONA, PRECIO, CAPACIDAD) VALUES (4, 'Grada Baja', 1000.00, 400);
INSERT INTO ZONA (ID_ZONA, NOMBREZONA, PRECIO, CAPACIDAD) VALUES (5, 'Grada Alta', 600.00, 600);

INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('A-101', 1);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('A-102', 1);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('A-103', 1);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('A-104', 1);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('A-105', 1);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('B-101', 2);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('B-102', 2);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('B-103', 2);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('B-104', 2);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('B-105', 2);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('C-101', 3);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('C-102', 3);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('C-103', 3);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('C-104', 3);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('C-105', 3);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('D-101', 4);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('D-102', 4);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('D-103', 4);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('D-104', 4);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('D-105', 4);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('E-101', 5);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('E-102', 5);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('E-103', 5);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('E-104', 5);
INSERT INTO ASIENTO (NUMERO_ASIENTO, ID_ZONA) VALUES ('E-105', 5);

INSERT INTO ASIENTO_EVENTO (ID_EVENTO, ID_ASIENTO, ESTADO) VALUES (1, 1, 'DISPONIBLE');
INSERT INTO ASIENTO_EVENTO (ID_EVENTO, ID_ASIENTO, ESTADO) VALUES (1, 2, 'DISPONIBLE');
INSERT INTO ASIENTO_EVENTO (ID_EVENTO, ID_ASIENTO, ESTADO) VALUES (1, 3, 'DISPONIBLE');
INSERT INTO ASIENTO_EVENTO (ID_EVENTO, ID_ASIENTO, ESTADO) VALUES (1, 4, 'DISPONIBLE');
INSERT INTO ASIENTO_EVENTO (ID_EVENTO, ID_ASIENTO, ESTADO) VALUES (1, 5, 'DISPONIBLE');
INSERT INTO ASIENTO_EVENTO (ID_EVENTO, ID_ASIENTO, ESTADO) VALUES (1, 6, 'DISPONIBLE');
INSERT INTO ASIENTO_EVENTO (ID_EVENTO, ID_ASIENTO, ESTADO) VALUES (1, 7, 'DISPONIBLE');
INSERT INTO ASIENTO_EVENTO (ID_EVENTO, ID_ASIENTO, ESTADO) VALUES (1, 8, 'DISPONIBLE');
INSERT INTO ASIENTO_EVENTO (ID_EVENTO, ID_ASIENTO, ESTADO) VALUES (1, 9, 'DISPONIBLE');
INSERT INTO ASIENTO_EVENTO (ID_EVENTO, ID_ASIENTO, ESTADO) VALUES (1, 10, 'DISPONIBLE');


